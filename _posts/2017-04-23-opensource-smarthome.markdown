# The open source centric smart home

Over the course last two years or so, I got myself some smart home devices. By now, I have connected devices for different aspects of my day to day life that I really enjoy using.
However, when using multiple systems, you get to a point where you get annoyed by having to control every device with a different App and want scenes and configurations across different devices. 
After having some discussions on twitter [and being explicitly asked about sharing my experiences](https://twitter.com/oxygen0211/status/855782919725514754), I want to do so now and outline the approach I took for combining them.

## Covered usecases
As a developer seeing products and frameworks come and go, I didn't want to use one commercial system for everything so I won't have to rely about on the willingness of one comany and want to at least have the option to some hacking on the systems on my own. This means I want all of my components and software to be open source or at least to have a relatively open API.
And since I am living in a rented apartment, pulling wires to all the rooms and installing components into the surge cabinet is not an option. Through this, the older systems based on a central Bus like KNX etc. are not that interresting to me and I tend to go more towards the new, wireless and specialized platforms. 
Of course, this makes interconnection more difficult, but since wanted some automation across all devices, this was my main focus over the last couple of weeks. For automation, I wanted things like:

* React to time and weather (turn on the lights on sunset)
* Centrally manage scenes (Light color and brightness, music, ...) for certain occasions (TV watching, Party, Going to bed,...)
* Have my home react to me being present or not (make sure the lights are off when I'm gone)
* Make my apartment react to events happening online (change the light color when I'm mentioned on Twitter, react to data in my fitness Apps,...)
* Adapt all smart devices based on operation of another one (set a dedicated light scene when turning on the TV)
* Start routines including multiple devices (wake me up using Music AND Light)

While the implementation of some of these automations is still work in progress, I managed to find a combination of hardware and software that acts as a platform that allows me to do all of that. Here's how it's built.

## Devices

### [Phillips Hue lightbulbs](http://www2.meethue.com)
These are certainly my most used components. Two years ago, I got myself a Hue starter kit with three E27 Bulbs since I wanted something cool for my sleeping room ceiling light.
This is still in daily use (that also means that I am still using the round version 1 bridge which lacks some functionality that the new one has).
After having installed one bulb in my sleeping room, I used the other two as a ceiling light in my home office and as an ambient light in my living room.
A few weeks ago, I added two E10-Spots to my doorway, a portable Hue Go lamp as a second ambient spot in my living room and a light strip for lighting the edge of my bed.
I am pretty pleased with the bulbs, the E27 are fairly bright, The E10 are not as powerful but four of them would still be sufficient to light my doorway (currently I am using two Hues and two normal LED spots since I still had them spare).
The only thing I would consider somewhat negative are that all the components are fairly pricy and that I had some initial trouble getting the Lightstrip to stick. The adhesive that was on there by default just wouldn't hold tight enough to the wood of my bed. However this was easily fixed with proper doublesided tape.

I think other bulbs of this kind like Lifx or the new Ikea ones are a equally good option, however, I don't have first hand experience with them and haven't seen the need to introduce a second system by now.

### [Sonos connected speakers](http://www.sonos.com)
Another pretty popular system. I am using one Play:3 speaker in my Sleeping room. Sonos offers speakers in different sizes that can be controlled via companion Apps for all common mobile and pc operation systems and offer an API. Speakers can by grouped by their location/room, connecting them to stereo or surround sound systems. 
You can also group these room setups together so that you can transfer the playing music from one room to another or stream one playlist to multiple rooms simultaneously. I am very pleased with their sound and am planning to extend my system for a while now but haven't done it yet.
This is mainly caused since the new components are a significant investment (Play:1, the smalles one, costs around 250â‚¬, the bigger ones way more) and the combination of my apartment's room layout and the usage of other speakers reduces the urge to buy more components.
In my living room, I have a old but good Teufel concecpt E Magnum 5.1 surround sound system hooked to my TV that also easily covers my semi-open kitchen and I also own a Bose mini soundlink Bluetooth speaker that delivers unbelievable sound for its size and prize. I mostly use it in my bathroom and home office when I want to.
My plans for extending the Sonos system are to add a stationary Play:1 to my bathroom (I absolutely love blasting music while showering :-)) and a Sonos Connect to the surround sound system in my livingroom. If I had to replace my current surround sound system I would very likely opt for Sonos or a similar system (for example Bang&Olufsen and Harman/Kardon are offering smiliar systems, but that wouldn't save any money).

### Samsung Smart TV
When I moved into my apartment, I bought the first TV of my own. This was almost four years ago and at this time, the marked was flooded by different Smart TV systems. After getting advice from a friend of mine who was running a local TV shop for multiple decades, it was clear to me that a Samsung one would be a good choice, so I got myself a 55" Samsung smart TV.
It sports sufficient ports - most importantly a few HDMIs and USBs - and connectivity over Wifi and Ethernet. There are many Apps from games (haven't tried any of them) to ambient animation apps (like the cliche animated fireplace) to the well-known streaming services like Netflix, Spotify and YouTube. 
Additionally, there are rudimentary ways to stream content from other devices wirelessly like Miracast (I switched to Mac and iPhone over the last year, so of no use for me), Samsung Screen share App (which is also of no use for me since I have no Samsung mobile device) and rudimentary APIs (a bit more on that later, however I haven't looked into it in detail). 
My experience with this one is that the picture is really nice and very well balanced. Also I could hook up my old (PC-) surround sound system with a relatively cheap optical to tripple-cinch transmitter. However, on the connectivity side I have some recuring problems. While streaming, the TV will often drop out of my Wifi for no apparent reason. This is probably a problem with my Wifi setup since the TV is mounted on an outer wall and the signal needs to travel through some walls, I have also seen some reception problems on my laptop when having it placed in front of the TV while connect with HDMI.
In the recent time, especially when improving my home automation and looking into Apple HomeKit, I considered getting an Apple TV, especially since (at least subjectively) functions on my TV are decreasing and the platform seems to loose significance. However, I am currently not using streaming that much. It's basically the same as with extending my Sonos system - the urge is currently not that big that I am willing to take the investment.

### [Withings Smart Body Analyzer](https://www.withings.com/products/body)
I have been overweight for the bigger part of my life and for a long time it was a hard enough struggle to not gain even more weight. Thankfully, as my life got gradually more stressful towards the end of my studies, I experienced first hand how much of a improvement in life quality regular exercise is providing me and have been sticking to a rather strict workout habit since then.
I got much fitter during the last years and am in a process of loosing weight right now, however this is still not easy and I need to gather proper data regularly for monitoring my progess and adapting my excercise and nutrition as needed.
For this, the Withings smart body analyzer is serving me very well. I have this one for a few years now, so it's still the first generation with a bit less functionality than the current ones but it reliably generates the data I need. It automatically reports measurements of weight, body fat and heart rate to Withings' backend from where it will be able on the companion app and other services. I have configured my iPhone companion app so that it will forward the data to HealthKit so it can be combined with data I am tracking in other apps.

## Software
Ok, I admit, until now, this post didn't have much to do with Open Source. But on the software side, we get our share of it, I promise. After all, the hardware systems alone are not much more than a fancier version of their non-smart versions without connectivity and software around them. Let's look into everything is interconnected in my system.

### [Home Assistant](https://home-assistant.io/)
Let's dive right into our central (and Open Source!) component. As I said before, all the systems have their own apps that work nicely, but if you are using several components and want them to interact and synchronize, you will soon want to have a central system to control them from one place. This is exaclty what Home Assistant does. It packs A TON (639 at time of writing, according to their page) of integrations of all differrent Kinds from Smart devices including the ones mentioned above, Apps and Applications from which I wouldn't have thought they might be useful in a smart home system but totally make sense once you think about it. An example for this is an SNMP trap which they use for presence detection through the Wifi connection of your phone (if your Router supports SNMP, of course) or an influxDB adapter (and other monitoring systems) so you can monitor the state of your whole home with production server grade system monitoring. Home Assistant is written in Python and relies on YAML based configuration that you can make in one file or split up into several ones as you like to. You can define scenes that can include any mix of different devices, groups by different aspects like rooms, kind and so on (it's not one or the other but you can add a device to multiple groups), scripts and more I haven't even looked at yet. It is also relatively light on resources and even provides a special Raspberry Pi custom OS if you want to deploy it there easily. However, I have my instance running in a Docker container on an old laptop that is running elemantary OS.

One core element of Home Assistant (and probably all Smarthome systems) is automation. The triggers can be events and state changes that can be produced by any component connected to the system. Automations I have set up so fare are:
* Turn on my Lights on sunset if I am home (tracked via find my iPhone based presence detection)
* Turn off my Lights when I leave home 
* Activate "TV Evening" scene when I turn on my TV. This means it turns off the lights in my sleeping room and home office and the ones in my living room and doorway on

There are other similar projects, for example eclipse's OpenHAB, but frankly none of the projects I have tried before gave me the quick wins and easiness in operation I was searching for. For me, Home Assistant seems to be the right choice.

### [Homebridge](https://github.com/nfarina/homebridge)
One thing I found initially problematic with Home Assistant is operating it in everyday situations like walking into a room for picking up something. Espially in the first days I would walk into a room, hit the light switch turning the lights off since they were turned out over the automation before, notice it while walking into the room, turn around, hit the light switch again to turn it on and be annoyed that the light (which is now on default settings) doesn't fit to the scene anymore and that triggering the switch did only affect the light connected to it, not ambient lights plugged into the socket. The reason for this is in my opinion is that the home assistant app (or more precisely their react frontend that you pin to your phone/tablet home screen via a bookmark is not intuitiv enough for operating it while doing something other. 

Apple's HomeKit offers way better integration for this and also enables us to let Siri change the settings for us. Home Assistant does not offer HomeKit support natively, but for this, there's Homebridge. Homebridge is a Node.js based Open Source project that does bridge the gap between HomeKit and devices that don't offer support natively. Of course, there's also an adapter for Home Assistant. With this, you can use HomeKit to turn on devices and set scenes. For scenes, they had to trick a bit and implemented them as digital switches but it works like a charm. I had it set up as a docker container (caution: I had to set --net=host on the run command to cope with the random port association it does) and configured within minutes. The most tedious part was that Homebridge and HomeKit weren't able to copy my groups to rooms and I had to create rooms again in HomeKit and associate the devices coorectly, but I consider this a minor thing.

Using Siri with Homebridge has become my default way of making manual settings on my smart home components, followed by using the HomeKit settings in my iPhone's control center.

I have still to refine some configuration and fix a few problems like currently not seeing my sonos in HomeKit, but I am positive that this will be solvable. Adding Homebridge to my setup has shown me that voice assistants are a very effective and comfortable way of interaction with my smarthome. However, a stationary voice assistant system would still be better than talking into my phone since might have lying it around somewhere ob be carrying something that makes it hard to activate Siri on my phone. 

### [IFTTT](https://ifttt.com/discover)
IFTTT (If this than that) is a nice service that allows you to connect two services so service A can react to events emitted by service B. These can be things like "If I post a photo on Facebook, also post it on Twitter" but has also many integrations for smart home components that allow us to let our house react to things happening online. Before introducing Home Assistant to my setup, I was using it to do all the automation for my smart home. These included things that are covered by Home Assistant now like "turn off the lights when I'm not home"/ "turn on the lights when I come home" but also more advanced things like color looping my livingroom ambient lights when I'm mentioned on Twitter, Changing their color to the average color of a photo when I post it to Instagram and changing the light color in my sleeping room based on my weight when I step on my scale (this one is rather esotheric but it gives you the kick you sometimes need). IFTTT also offers a "Maker Channel" that can be used as a webhook to trigger an events by services that are not officially supported or via own scripts and software. Home Assistant can utilize this channel to trigger IFTTT for events happening in the smarthome or have an automation be triggered by IFTTT for something happening online. The latter requires that Home Assitant's API is available from the internet. In my case, this requires setting up dynamic DNS (since I don't have a static IP for my home internet connection) and port forwarding in my router. I haven't done that yet and by this also didn't integrate IFTTT with Home Assistant yet but I am planning to do so because I have seen that it is not a very good option to have IFTTT and Home Assistant control the devices in parallel since that makes behavior of the smarthome rather unpredictable. Also, some components (for example Sonos) currently don't have an IFTTT integration, so using Home Assistant's automation to control components and scenes gives you more functionality. 

## What's next
This is what I have got so far, but I consider my Smart Home to be a continuous project that will get enhancements step by step in the future. I have some more things I still need to implement in my mind:

* As described above, IFTTT integration is still open. This also includes automation on Home Assistant side for events triggered by IFTTT events
* Presence detection for rooms and motion detection. While having Apps and Siri integration is a good start, I want my smart home to just react on me entering a room without having to tap anything on my phone. Currently, I see two options for this which could also be implemented in parallel (altough that might be unneccessary): Adding connected motion detectors or adding bluetooth beactons to each room. However, bluetooth beacons have the downside of needing to carry around a device so that recognization works. Of course, I could also use cameras which would also be usable for security, but I don't really like the thought of being in the eye of a camera all the time just for motion detection, so as long as I don't see an other real benefit that weights heavier than this concern, this one is out for me.
* More smart lights. Over the course of the next months and years, I will probably replace all bulbs breaking down with smart bulbs. Currently, two lights in my doorway, one in my kitchen and one in my bathroom are still "dumb bulbs". Also, there's some more room for ambient light like at the bottom of my couches and lighting the walls on many places in the whole apartment.
* I have living room furniture that has glass elements with LED backlights, so the front edge glows in a configurable clolor. With the stock setup, this can only be done with the proprietary remote control (boo!) and I would love to add this to my scenes since I basically never turn them on manually. I want to try adding smart control for those elements by utilizing the GPIO ports of a Raspberry Pi or [C.H.I.P](https://getchip.com/) Stay tuned, this will surely result in a Blog post.
* Make my washing mashine smart. This will be one of my next projects. During casual talks about home chores with several people, I have recognized a common problem that I want to experiment with: while basically all washing mashines built in the last ~10 years have an accustic alarm when they have finished a cycle, they are of not much use for many people. Mostly this is because the washing mashine is in the cellar, doors are closed or people are just somewhere else and then forget about it. My plan is to utilize a C.H.I.P that I recently bought, hook up an old headset and write an application that listens for the beeping sound of the washing mashine and then trigger a webhook to send an notification - or trigger an event for an automation in my smart home. By this, you can get digitally notified, have the lighting changed or whatever when there's a machine of laundry waiting to be handeled. Stay tuned, I will blog about this.
* Make my Kitchen smart. I have noticed that while there are smart components all over my apartment, my kitchen is still pretty traditional, no connected device at all. While I don't really have a plan, I think there will soon come some smart device. I don't cook that much myself, so it won't be one of those fancy, expensive kitchen machines since they just won't be used enough to make sense. The chance for a smart kitchen scale is much greater since I do weight basically all of my food to control my calory intake under control. Also, I really like my nespresso machine - I know I might be asking for discussion here, but let's just settle with tastes are different and I like this system - and have an eye on their connected machine. My machine is still working like a charm, but when the time comes to upgrade, It will very likely be a connected one.
* Add whole-room voice assistants. I see that voice control with Siri is working pretty good with my smart home, however having to carry around my iPhone all the time and directly talking into it is not that convenient. Also, I have got some very good reviews of Amazon Echo owners, so I have thrown an eye on Amazon Echo and Google Home recently. While I neither have placed an order nor chosen which system to use yet, it's probably just a matter of time until I get the first one or two devices to place them  around my apartment.
* Smart shades. Currently, I don't have shades in my apartment since it's on the 4th floor and doesn't have much spots where you can look into it from the outside. However, on some occasions, I would like to be able to block the sun or views from one window or the oter. Since I don't see a really urgent need to change this, I have played with thought of getting some connected shades like [Lutron's Serenas](https://www.serenashades.com/).
* Advanced automation. OK, here's one that doesn't involve new hardware. There are a few more things that I want to automate. For example, I have already set up internet connection speed checks, but my home doesn't react to the measurements yet. I still have to figure out what this reaction should be. Also, I want what might be best described as "dynamic scenes" like having ambient lights change their color to a random one (but all to the same color per room). Or dimming down the lights over time. This also includes a multi device wakeup call. Especially in winter (right now this is less of a problem), I like to have my sonos to start blasting music and a bit later the lights to start getting brighter over ~30 minutes. I still need to figure out the best way to implement this in Home Assistant.
* Make my heating smart. I think one of the first devices that got me into the idea of building a smart home was the Nest thermostat and I still like the idea today. However, my apartment does not have a central thermostat but a controlable radiator in each room. Right now, there are several radiator thermostats that allow to make them connected, but with 5 radiators to upgrade ower my whole apartment, this is quite an investment that - given that I currently have no idea how long I will stay in this apartment - I am currently not willing to make. But this is still on my backlog.
* Add my car into the mix. I have an undeniable weakness for fancy cars and motorcycles. I love my car and spend quite some time in it since I am commuting about 100km each day and am also often driving around in my free time (e.g. to the gym. That's how it is living in a rural area...), so one idea that comes naturally with this is getting one of those connected car adapters like offered by [Automatic](https://www.automatic.com/). This would not only allow me to get some analytics on my driving but could also integrate into my smart home presence and zone detection, setting up my home when I leave work or arrive at home and much more.
* Get a smart Mirror for my doorway. I have seen the concept of a smart mirror like [this one](http://michaelteeuw.nl/post/84026273526/and-there-it-is-the-end-result-of-the-magic) and fell in love with it. It displays current information like news, social media interactions or the weather in an elegant way made for a quick, brief look - so exactly what I need when heading out of the door. Most of the ones you see are DIY projects that involves mounting a ~23" TFT to a acrylic pane with dual mirror foil and hooking it up to a miniature computing device like a Raspberry Pi or C.H.I.P. There are also builds with chromecast, but I would prefer a micro PC and using https://github.com/MichMich/MagicMirror
